<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - EcoGrid</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
    header, footer { text-align: center; margin-bottom: 20px; }
    .navbar { display: flex; justify-content: space-between; align-items: center; background-color: #4CAF50; padding: 10px 20px; border-radius: 8px; color: white; }
    .logo { font-weight: bold; font-size: 1.5em; }
    .nav-links { list-style: none; display: flex; gap: 15px; margin: 0; padding: 0; }
    .nav-links li a { color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; }
    .nav-links li a:hover, .nav-links li a.active { background-color: #388E3C; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e0f7fa; }
    button { padding: 6px 12px; border: none; background-color: #f44336; color: white; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #d32f2f; }
    a { text-decoration: none; color: #4CAF50; }
    .allocate-btn { background-color: #00b894; }
    .allocate-btn:hover { background-color: #009975; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header>
    <div class="navbar">
      <div class="logo">⚡ EcoGrid</div>
      <ul class="nav-links" id="navLinks">
        <li><a href="/" class="active">Home</a></li>
        <li><a href="/about">About Us</a></li>
        <li><a href="/contact">Contact</a></li>
        {% if user %}
          {% if user.role == "admin" %}
            <li><a href="/heatmap">Heatmap</a></li>
          {% endif %}
          <li><img src="{{ url_for('static', filename='images/user-icon.jpg') }}" alt="User Icon" class="user-icon" id="userIcon" style="cursor:pointer;width:40px;border-radius:50%;" /></li>
          <li><a href="{{ url_for('logout') }}" class="button">Logout</a></li>
        {% else %}
          <li><a href="/login" class="button">Login</a></li>
          <li><a href="/signup" class="button">Signup</a></li>
        {% endif %}
      </ul>
    </div>
  </header>

  <main>
    <section>
      <h2>Welcome, {{ user.name }}!</h2>
      <p>Manage users and monitor predicted electricity usage.</p>
    </section>

    <section>
      <h2>Registered Users & Current Plans</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Plan</th>
             <th>Remaining Days</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Predicted Electricity (Next 1 min)</h2>
      <p>Solar: <span id="avgSolar">--</span> V</p>
      <p>Wastewater: <span id="avgWastewater">--</span> V</p>
      <p>Total Predicted Electricity: <span id="predictedElectricity">--</span> V</p>
      <button onclick="fetchPrediction()">Update Now</button>
    </section>

    <section>
      <h2>AI Energy Allocation</h2>
      <button class="allocate-btn" onclick="allocateEnergy()">Allocate Energy to Users</button>
      <p id="allocationMessage"></p>
    </section>

    <section>
      <h2>Energy Generation (Last 7 Days)</h2>
      <canvas id="generationChart" width="600" height="300"></canvas>
    </section>

    <section>
      <h2>View Heatmap</h2>
      <a href="{{ url_for('heatmap_page') }}">Go to Heatmap</a>
    </section>
  </main>

  <script>
    const labels = ["Oct 18","Oct 19","Oct 20","Oct 21","Oct 22","Oct 23","Oct 24"];
    const data = [4.2, 5.1,4.8,6.0,5.6,6.3,7.0];

    const ctx = document.getElementById('generationChart').getContext('2d');
    const chart = new Chart(ctx,{
        type:'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Energy generated (kWh)',
                data: data,
                backgroundColor: '#4CAF50',
                borderColor: '#388E3C',
                borderWidth: 1,
                borderRadius: 6,
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {color: 'rgba(0,0,0,0.1)'},
                    title: {display: true, text: 'kwh', font: {weight: 'bold'}}
                },
                x: {
                    title: {display: true, text: 'Date',font:{weight: 'bold'}}
                }
            },
            plugins: {
                legend: { display:true ,labels: {color: '#333'}},
                title: { display: true, text: 'Energy Generation Over the Last 7 Days', font: {size: 18, weight: 'bold'}, color: '#2E7D32'}
            }
        }
    });
async function fetchUsers() {
    try {
        const response = await fetch("/api/users");
        if (!response.ok) throw new Error("Failed to fetch users");

        const users = await response.json();
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        users.forEach(user => {
            // Determine plan name
            let planName = user.subscription?.plan || user.plan || 'No Plan';

            // Calculate remaining days
            let remainingDays = '--';
            if (user.subscription?.expiry_date) {
                const today = new Date();
                const expiry = new Date(user.subscription.expiry_date);
                const diffTime = expiry - today;
                remainingDays = diffTime > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${planName}</td>
                <td>${remainingDays}</td>
                <td>${user.location?.latitude || ''}</td>
                <td>${user.location?.longitude || ''}</td>
                <td><button onclick="deleteUser('${user.email}', this)">Delete</button></td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        alert("Error fetching users.");
    }
}

async function deleteUser(email, btn) {
    if (!confirm(`Are you sure you want to delete user: ${email}?`)) return;
    try {
        const response = await fetch("/api/users/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            btn.closest("tr").remove();
        } else {
            alert(data.message);
        }
    } catch (err) {
        console.error(err);
        alert("Error deleting user.");
    }
}

async function fetchPrediction() {
    try {
        const response = await fetch("/api/predict_electricity");
        if (!response.ok) throw new Error("Failed to fetch prediction");

        const data = await response.json();

        document.getElementById("avgSolar").textContent = data.avg_solar;
        document.getElementById("avgWastewater").textContent = data.avg_wastewater;
        document.getElementById("predictedElectricity").textContent = data.predicted_electricity;

    } catch (err) {
        console.error(err);
        alert("Error fetching electricity prediction.");
    }
}


// Fetch every minute
window.onload = () => {
    fetchUsers();
    fetchPrediction();
    setInterval(fetchPrediction, 60000);
};

// AI allocation of electricity to users
async function allocateEnergy() {
    const email = prompt("Enter user email:");
    const required_voltage = parseFloat(prompt("Enter required voltage:"));

    try {
        const response = await fetch("/api/allocate_energy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, required_voltage })
        });

        const data = await response.json();
        alert(data.message);
        console.log(data);
    } catch (err) {
        console.error(err);
        alert("Error allocating energy.");
    }
}

window.onload = () => {
    fetchUsers();
    fetchPrediction();
    setInterval(fetchPrediction, 60000); // refresh every 60 sec
};
  </script>

  <footer>
    <p>© 2025 EcoGrid | Admin Panel</p>
  </footer>
</body>
</html>
